name: Merge M3U

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  merge-m3u:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Merge all with 100MB limit
      run: |
        MAX_SIZE=$((100*1024*1024))  # 100MB limit
        TMP_DIR=merged_tmp
        mkdir -p $TMP_DIR
        COMBINED="$TMP_DIR/combined-playlist.m3u"
        echo -n > $COMBINED

        find . -type f -name "*vod.m3u" ! -path "./$TMP_DIR/*" ! -name "combined-playlist.m3u" | while read file; do
          base=$(basename "$file" .m3u)
          awk -v grp="$base" '
            NR == 1 && $0 == "#EXTM3U" { next }
            /^#EXTINF/ {
              if ($0 ~ /group-title="/) {
                sub(/group-title="[^"]*"/, "group-title=\"" grp "\"")
              } else {
                sub(/#EXTINF:/, "#EXTINF:-1 group-title=\"" grp "\",")
              }
              print
              getline
              print
              next
            }
            { print }
          ' "$file" >> "$COMBINED"

          # Check if size exceeds 100MB
          if [ $(stat -c%s "$COMBINED") -ge $MAX_SIZE ]; then
            echo "Reached 100MB limit. Stopping merge."
            # Remove last appended file to stay below 100MB
            truncate -s $MAX_SIZE "$COMBINED"
            break
          fi
        done

        sed -i '1i #EXTM3U' "$COMBINED"

        mv "$COMBINED" MERGED_VOD.m3u
        rm -rf $TMP_DIR

    - name: Commit and push merged playlist
      run: |
        git config user.name "${{ secrets.GIT_U }}"
        git config user.email "${{ secrets.GIT_E }}"
        git add MERGED_VOD.m3u
        if ! git diff --cached --quiet; then
          git commit -m "Auto-merged m3u playlists $(date -u +"%Y-%m-%d %H:%M UTC")"
          git push
        else
          echo "No changes to commit"
        fi
